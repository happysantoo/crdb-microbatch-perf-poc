@startuml Batching Architecture Sequence Diagram

actor VajraPulse as VP
participant "CrdbInsertTask" as Task
participant "MicroBatcher" as Batcher
participant "CrdbBatchBackend" as Backend
participant "TestInsertRepository" as Repo
database "CockroachDB" as DB

== Initialization ==
VP -> Task: init()
activate Task
Task -> Task: initializeMetrics()
Task -> Task: initializeBatcher()
Task -> Batcher: new MicroBatcher(backend, config, meterRegistry)
note right: Backend injected via Spring DI\nPassed to MicroBatcher constructor
deactivate Task

== Task Execution (Item Submission) ==
VP -> Task: execute(iteration)
activate Task
Task -> Task: generateTestData()
Task -> Task: submitCounter.increment()
Task -> Task: Timer.start()
Task -> Batcher: submit(testInsert)
activate Batcher
note right: Item added to queue\nQueue depth increases

== Batching Logic (Vortex Internal) ==
Batcher -> Batcher: Check batch conditions\n(size >= 50 OR time >= 50ms)
alt Batch Ready
    Batcher -> Batcher: Collect items from queue\n(up to 50 items)
    Batcher -> Backend: dispatch(batch)
    activate Backend
    note right: Batch of 50 items\npassed to backend
    
    == Batch Processing ==
    Backend -> Backend: batchCounter.increment()
    Backend -> Backend: rowCounter.increment(50)
    Backend -> Backend: Timer.start()
    Backend -> Repo: insertBatch(batch)
    activate Repo
    Repo -> DB: JDBC batch insert (50 rows)
    activate DB
    DB --> Repo: int[] updateCounts
    deactivate DB
    Repo --> Backend: updateCounts[]
    deactivate Repo
    
    == Result Mapping ==
    Backend -> Backend: Map updateCounts to\nSuccessEvent/FailureEvent
    Backend -> Backend: batchSuccessCounter.increment()
    Backend -> Backend: rowSuccessCounter.increment(50)
    Backend -> Backend: Timer.stop()
    Backend --> Batcher: BatchResult(successes, failures)
    deactivate Backend
    
    == Item Result Extraction ==
    Batcher --> Task: CompletableFuture.complete(BatchResult)
    deactivate Batcher
    Task -> Task: future.get() - wait for batch
    Task -> Task: findItemResult(item, batchResult)
    note right: Find this specific item\nin batch results
    Task -> Task: submitSuccessCounter.increment()
    Task -> Task: Timer.stop()
    Task --> VP: TaskResult.success()
else Batch Not Ready
    Batcher -> Batcher: Wait for more items\nor linger time
    note right: Item stays in queue\nwaiting for batch
    Batcher --> Task: CompletableFuture (pending)
    deactivate Batcher
    Task -> Task: future.get() - blocks until batch ready
    note right: Task waits for batch\ncompletion
end
deactivate Task

== Metrics Summary ==
note over Task,Backend
**Item-Level Metrics (Task)**:
- crdb.submits.total
- crdb.submits.success
- crdb.submit.latency

**Batch-Level Metrics (Backend)**:
- crdb.batches.total
- crdb.batches.success
- crdb.batch.rows.success
- crdb.batch.duration
end note

@enduml

